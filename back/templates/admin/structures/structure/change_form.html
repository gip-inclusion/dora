{% extends "admin/change_form.html" %}
{% load static %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'admin/css/moderation_change_form.css' %}">
{% endblock %}

{% block content_title %}
  {{ block.super }}
  {% if moderation_pending %}
    <fieldset class="module">
      <h2 class="moderation-banner-title">Modération du rattachement</h2>
      <div class="submit-row moderation-vertical">
        <p>Vérifier la légitimité du rattachement à partir de l’identité des utilisateurs rattachés et du détail des demandes d’orientation émises (en bas de la page).</p>
        <p>En fonction du résultat de ces vérifications, <b>approuver</b> ou <b>rejeter</b> le rattachement en cliquant sur l’un des boutons ci-dessous.</p>
        <div class="moderation-actions-row">
          <form method="post" action="{% url 'admin:moderation_approve' original.pk %}" class="moderation-action-form">
            {% csrf_token %}
            <div class="moderation-action-column">
              <input type="submit" value="Approuver" class="moderation-approve-button" />
              <div class="moderation-help">
                <p>Effets de l’action <i>Approuver</i> :</p>
                <ul>
                  <li>la structure passe au statut de modération <i>Validé</i> ;</li>
                  <li>toutes les demandes d’orientation ayant le statut <i>En cours de modération</i> passent au statut <i>Ouverte / En cours de traitement</i> ;</li>
                  <li>envoi des e-mails pour toutes ces demandes d’orientation.</li>
                </ul>
              </div>
            </div>
          </form>
          <form method="post" action="{% url 'admin:moderation_reject' original.pk %}" class="moderation-action-form">
            {% csrf_token %}
            <div class="moderation-action-column">
              <div class="moderation-reject-row">
                <label for="reason" class="required">Motif du rejet :</label>
                <input type="text" id="moderation-reject-reason-field" name="reason" required class="moderation-reject-input" />
                <input type="submit" id="moderation-reject-submit-button" disabled value="Rejeter" class="moderation-reject-button" />
              </div>
              <div class="moderation-help">
                <p>Effets de l’action <i>Rejeter</i> :</p>
                <ul>
                  <li>tous les membres (réels ou potentiels, admins ou non) sont détachés de la structure ;</li>
                  <li>envoi d’e-mails à ces utilisateurs pour leur expliquer la situation et les inviter à nous contacter ;</li>
                  <li>désactivation de l’ensemble de ces utilisateurs ;</li>
                  <li>la structure passe au statut de modération <i>Nouvelle modération nécessaire</i> ;</li>
                  <li>les demandes d’orientation en cours de modération passent au statut <i>Supprimée par la modération</i>.</li>
                </ul>
              </div>
            </div>
          </form>
        </div>
      </div>
    </fieldset>
    <script nonce="{{ csp_nonce }}">
      (function() {
        const reasonField = document.getElementById('moderation-reject-reason-field');
        const rejectButton = document.getElementById('moderation-reject-submit-button');
        reasonField.addEventListener('input', function () {
          rejectButton.disabled = reasonField.value.trim() === '';
        });

        const approveForm = document.querySelector('form[action*="moderation_approve"]');
        if (approveForm) {
          approveForm.addEventListener('submit', function (e) {
            if (!confirm('Êtes-vous sûr de vouloir approuver ce rattachement ?')) {
              e.preventDefault();
            }
          });
        }
        const rejectForm = document.querySelector('form[action*="moderation_reject"]');
        if (rejectForm) {
          rejectForm.addEventListener('submit', function (e) {
            if (!confirm('Êtes-vous sûr de vouloir rejeter ce rattachement ?')) {
              e.preventDefault();
            }
          });
        }
      })();
    </script>
  {% endif %}
{% endblock %}
